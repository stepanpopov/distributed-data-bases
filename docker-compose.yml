# Общие настройки для всех PostgreSQL сервисов
x-postgres-common: &postgres-common
  image: postgres:16
  environment:
    POSTGRES_DB: hotel_management
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: password
  command: >
    postgres
    -c wal_level=logical
    -c max_wal_senders=10
    -c max_replication_slots=40
    -c max_logical_replication_workers=24
    -c max_worker_processes=40
  networks:
    - hotel_network
  restart: unless-stopped

# Общие настройки для филиальных узлов
x-filial-common: &filial-common
  <<: *postgres-common
  depends_on:
    postgres-central:
      condition: service_healthy

# Настройки для Flask API
x-api-common: &api-common
  build: ./backend
  environment:
    FLASK_ENV: development
    FLASK_DEBUG: 1
    CENTRAL_DB_URL: postgresql://postgres:password@postgres-central:5432/hotel_management
    FILIAL1_DB_URL: postgresql://postgres:password@postgres-filial1:5432/hotel_management
    FILIAL2_DB_URL: postgresql://postgres:password@postgres-filial2:5432/hotel_management
    FILIAL3_DB_URL: postgresql://postgres:password@postgres-filial3:5432/hotel_management
  networks:
    - hotel_network
  restart: unless-stopped
  depends_on:
    postgres-central:
      condition: service_healthy
    postgres-filial1:
      condition: service_healthy
    postgres-filial2:
      condition: service_healthy
    postgres-filial3:
      condition: service_healthy

services:
  # Центральный узел (головной офис)
  postgres-central:
    <<: *postgres-common
    container_name: hotel_central_node
    ports:
      - "5432:5432"
    volumes:
      - central_data:/var/lib/postgresql/data
      - ./init/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./init/fill.sql:/docker-entrypoint-initdb.d/02-fill.sql
      - ./init/central_node_replication.sql:/docker-entrypoint-initdb.d/03-replication.sql
      - ./init/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      hotel_network:
        ipv4_address: 172.20.0.10

  # Филиал 1 (Отель в Москве)
  postgres-filial1:
    <<: *filial-common
    container_name: hotel_filial1_node
    ports:
      - "5433:5432"
    volumes:
      - filial1_data:/var/lib/postgresql/data
      - ./init/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./init/filial_node_replication.sql:/docker-entrypoint-initdb.d/02-replication.sql
      - ./init/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      hotel_network:
        ipv4_address: 172.20.0.11

  # Филиал 2 (Отель в СПб)
  postgres-filial2:
    <<: *filial-common
    container_name: hotel_filial2_node
    ports:
      - "5434:5432"
    volumes:
      - filial2_data:/var/lib/postgresql/data
      - ./init/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./init/filial_node_replication.sql:/docker-entrypoint-initdb.d/02-replication.sql
      - ./init/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      hotel_network:
        ipv4_address: 172.20.0.12

  # Филиал 3 (Отель в Казани)
  postgres-filial3:
    <<: *filial-common
    container_name: hotel_filial3_node
    ports:
      - "5435:5432"
    volumes:
      - filial3_data:/var/lib/postgresql/data
      - ./init/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./init/filial_node_replication.sql:/docker-entrypoint-initdb.d/02-replication.sql
      - ./init/pg_hba.conf:/etc/postgresql/pg_hba.conf
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      hotel_network:
        ipv4_address: 172.20.0.13

  # Flask API сервис
  api:
    <<: *api-common
    container_name: hotel_api
    ports:
      - "5000:5000"
    volumes:
      - ./backend:/app
    command: python app.py


networks:
  hotel_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

volumes:
  central_data:
  filial1_data:
  filial2_data:
  filial3_data:
