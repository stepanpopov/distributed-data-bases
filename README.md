# Распределенная база данных отелей с репликацией PostgreSQL

Система управления сетью отелей с настроенной репликацией PostgreSQL по схеме фрагментации.

## Архитектура репликации

### Типы репликации:
- **РОК** (Репликация с основной копией) - справочные данные от центра к филиалам
- **РКД** (Репликация с консолидацией данных) - операционные данные от филиалов к центру  
- **РБОК** (Репликация без основной копии) - данные гостей между всеми узлами

### Узлы:
- **Центральный узел** (192.168.1.10:5432) - головной офис, управляет справочниками
- **Филиал 1** (192.168.1.100:5433) - отель в Москве (hotel_id=1)
- **Филиал 2** (192.168.1.101:5434) - отель в СПб (hotel_id=2)  
- **Филиал 3** (192.168.1.102:5435) - отель в Казани (hotel_id=3)

## Схема фрагментации данных

| Таблица | Тип репликации | Основная копия | Описание |
|---------|---------------|----------------|----------|
| hotels | РОК, МС, 1р/д | Центр | Изменяются только в центре |
| cities | РОК, МС, 1р/д | Центр | Справочник городов |
| categories_hotel | РОК, МС, 1р/д | Центр | Категории отелей |
| categories_room | РОК, МС, 1р/д | Центр | Категории номеров |
| positions | РОК, МС, 1р/д | Центр | Должности сотрудников |
| loyalty_cards | РОК, МС, 1р/д | Центр | Карты лояльности |
| types_amenities | РОК, МС, 1р/д | Центр | Типы удобств |
| rooms | РКД, 1р/д | Филиалы | Номера отелей |
| employees | РКД, 1р/д | Филиалы | Сотрудники |
| amenities | РКД, 1р/д | Филиалы | Удобства отелей |
| reservations | РКД, отложенные | Филиалы | Бронирования |
| details_reservations | РКД, отложенные | Филиалы | Детали бронирований |
| payments | РКД, 1р/3ч | Филиалы | Платежи |
| guests | РБОК, асинхронное | Все узлы | Гости (синхронизация между всеми) |
| payments_amenities | ЛТ | Локально | Только локальное использование |
| room_reservation_guests | ЛТ | Локально | Только локальное использование |

## Быстрый старт

### 1. Запуск всех узлов
```bash
# Запуск всех контейнеров
docker-compose up -d

# Проверка статуса
docker-compose ps
```

### 2. Настройка репликации
```bash
# Выполнить после того, как все контейнеры запустились
./setup_replication.sh
```

### 3. Проверка репликации
```bash
# Подключение к центральному узлу
psql -h localhost -p 5432 -U postgres -d hotel_management

# Подключение к филиалу 1 (Москва)
psql -h localhost -p 5433 -U postgres -d hotel_management

# Просмотр активных подписок
SELECT * FROM pg_subscription;

# Просмотр публикаций
SELECT * FROM pg_publication;
```

## Детальная последовательность запуска

### Этап 1: Инициализация (автоматически при docker-compose up)
1. Создание схемы БД на всех узлах
2. Заполнение начальными данными
3. Создание публикаций и пользователей репликации
4. Настройка локальных конфигураций филиалов

### Этап 2: Настройка репликации (скрипт setup_replication.sh)
1. Проверка готовности всех узлов
2. Создание подписок филиалов на справочные данные (РОК)
3. Создание подписок центра на данные филиалов (РКД)
4. Настройка синхронизации гостей между всеми узлами (РБОК)

## Особенности работы

### Ограничения филиалов
- Каждый филиал может изменять данные только "своего" отеля
- Автоматическая проверка через триггеры `check_hotel_ownership()`
- Автоматическое назначение `hotel_id` при вставке данных

### Разрешение конфликтов гостей
- При конфликтах по документам - обновление существующей записи
- Сохранение максимального количества бонусных баллов
- Обновление контактной информации

### Справочные данные
- Изменяются только в центральном офисе
- Автоматическая репликация на филиалы раз в сутки (моментальный снимок)

## Мониторинг репликации

### Проверка статуса подписок
```sql
-- На любом узле
SELECT 
    subname,
    received_lsn,
    latest_end_lsn,
    latest_end_time
FROM pg_stat_subscription;
```

### Проверка активных публикаций  
```sql
-- На любом узле
SELECT 
    pubname,
    puballtables,
    pubinsert,
    pubupdate,
    pubdelete
FROM pg_publication;
```

### Проверка слотов репликации
```sql
-- На публикующем узле
SELECT 
    slot_name,
    plugin,
    slot_type,
    active
FROM pg_replication_slots;
```

## Остановка и очистка

```bash
# Остановка всех служб
docker-compose down

# Остановка с удалением данных
docker-compose down -v

# Полная очистка (включая образы)
docker-compose down -v --rmi all
```

## Структура проекта

```
.
├── docker-compose.yml          # Конфигурация всех узлов
├── setup_replication.sh        # Скрипт настройки репликации
├── README.md                   # Документация
├── schema/
│   └── all.sql                 # Схема базы данных
├── fill/
│   └── fill.sql                # Начальные данные
└── replication/
    ├── central_node_setup.sql  # Настройка центрального узла
    ├── filial_node_setup.sql   # Настройка филиалов
    ├── filial1_config.sql      # Конфигурация филиала 1
    ├── filial2_config.sql      # Конфигурация филиала 2
    ├── filial3_config.sql      # Конфигурация филиала 3
    └── pg_config.conf          # Конфигурация PostgreSQL
```

## Подключения к узлам

| Узел | Хост | Порт | Описание |
|------|------|------|----------|
| Центр | localhost | 5432 | Головной офис |
| Филиал 1 | localhost | 5433 | Москва |
| Филиал 2 | localhost | 5434 | Санкт-Петербург |  
| Филиал 3 | localhost | 5435 | Казань |

**Учетные данные:**
- Пользователь: `postgres`
- Пароль: `password`  
- База данных: `hotel_management`