{% extends "base.html" %}

{% block title %}–†–µ—Å–µ–ø—à–µ–Ω - {{ city_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('reception_dashboard') }}">–†–µ—Å–µ–ø—à–µ–Ω</a></li>
                    <li class="breadcrumb-item active">{{ city_name }}</li>
                </ol>
            </nav>

            <h1>üè® –†–µ—Å–µ–ø—à–µ–Ω - {{ city_name }}</h1>
            <p class="text-muted">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º–∏ –≥–æ—Ä–æ–¥–∞</p>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h3>–ê–∫—Ç–∏–≤–Ω—ã–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ({{ reservations|length }})</h3>
                <div>
                    <a href="{{ url_for('reception_dashboard') }}" class="btn btn-outline-secondary">
                        ‚Üê –ù–∞–∑–∞–¥ –∫ –≥–æ—Ä–æ–¥–∞–º
                    </a>
                    <button class="btn btn-outline-info" onclick="location.reload()">
                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
    </div>

    {% if reservations %}
    <div class="row">
        <div class="col-md-12">
            <div class="table-responsive">
                <table class="table table-hover border">
                    <thead class="table-light">
                        <tr>
                            <th class="text-secondary">‚Ññ –ë—Ä–æ–Ω–∏</th>
                            <th class="text-secondary">–ì–æ—Å—Ç—å</th>
                            <th class="text-secondary">–û—Ç–µ–ª—å</th>
                            <th class="text-secondary">–î–∞—Ç—ã</th>
                            <th class="text-secondary">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                            <th class="text-secondary">–ù–æ–º–µ—Ä</th>
                            <th class="text-secondary">–°—Ç–∞—Ç—É—Å</th>
                            <th class="text-secondary">–°—É–º–º–∞</th>
                            <th class="text-secondary">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reservation in reservations %}
                        <tr class="{% if reservation.status == 'pending' %}table-light border-start border-warning border-3{% elif reservation.status == 'confirmed' %}table-light border-start border-success border-3{% endif %}">
                            <td>
                                <strong class="text-dark">#{{ reservation.id }}</strong>
                                <br>
                                <small class="text-muted">{{ reservation.create_date }}</small>
                            </td>
                            <td>
                                <strong class="text-dark">{{ reservation.first_name }} {{ reservation.last_name }}</strong>
                                <br>
                                <small class="text-muted">üìû {{ reservation.phone_number }}</small>
                                {% if reservation.email %}
                                <br>
                                <small class="text-muted">‚úâÔ∏è {{ reservation.email }}</small>
                                {% endif %}
                            </td>
                            <td>
                                <strong class="text-secondary">{{ reservation.hotel_name }}</strong>
                            </td>
                            <td>
                                <small class="text-secondary">
                                    <strong>–ó–∞–µ–∑–¥:</strong> {{ reservation.start_date }}<br>
                                    <strong>–í—ã–µ–∑–¥:</strong> {{ reservation.end_date }}
                                </small>
                            </td>
                            <td>
                                {% if reservation.category_name %}
                                    <span class="badge bg-light text-dark border">{{ reservation.category_name }}</span>
                                    <br>
                                    <small class="text-muted">–ì–æ—Å—Ç–µ–π: {{ reservation.total_guest_number }}</small>
                                {% else %}
                                    <span class="text-muted">–ù–µ —É–∫–∞–∑–∞–Ω–æ</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if reservation.room_id %}
                                    <span class="badge bg-light text-success border border-success">–ù–∞–∑–Ω–∞—á–µ–Ω</span>
                                    <br>
                                    <small class="text-secondary">–ù–æ–º–µ—Ä #{{ reservation.room_id }}</small>
                                {% else %}
                                    <span class="badge bg-light text-warning border border-warning">–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if reservation.status == 'pending' %}
                                    <span class="badge bg-light text-warning border border-warning">‚è≥ –û–∂–∏–¥–∞–µ—Ç</span>
                                {% elif reservation.status == 'confirmed' %}
                                    <span class="badge bg-light text-success border border-success">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>
                                {% endif %}
                                <br>
                                {% if reservation.payments_status == 'paid' %}
                                    <small class="text-success">üí≥ –û–ø–ª–∞—á–µ–Ω</small>
                                {% else %}
                                    <small class="text-muted">üí∞ –ù–µ –æ–ø–ª–∞—á–µ–Ω</small>
                                {% endif %}
                            </td>
                            <td>
                                <strong class="text-dark">{{ reservation.total_price }} ‚ÇΩ</strong>
                            </td>
                            <td>
                                {% if reservation.status == 'pending' or (reservation.status == 'confirmed' and not reservation.room_id) %}
                                <button class="btn btn-outline-primary btn-sm mb-1"
                                        onclick="openRegisterModal({{ reservation.id }}, '{{ (reservation.first_name + ' ' + reservation.last_name)|replace("'", "\\'") }}', {{ reservation.hotel_id }}, {{ reservation.requested_room_category or 'null' }}, '{{ reservation.start_date }}', '{{ reservation.end_date }}', {{ reservation.payer_id or 'null' }})">
                                    üè® –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
                                </button>
                                {% else %}
                                <span class="text-success">
                                    ‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
                                </span>
                                {% endif %}

                                <br>

                                <a href="{{ url_for('reservation_details', reservation_id=reservation.id) }}"
                                   class="btn btn-outline-secondary btn-sm mt-1">
                                    üìã –î–µ—Ç–∞–ª–∏
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-info text-center">
                <h4>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h4>
                <p>–í –≥–æ—Ä–æ–¥–µ {{ city_name }} –Ω–µ—Ç –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π, —Ç—Ä–µ–±—É—é—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏.</p>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card border-light shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="text-secondary">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π - {{ city_name }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded border">
                                <h4 class="text-secondary">{{ reservations|length }}</h4>
                                <p class="text-muted mb-0">–í—Å–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded border">
                                <h4 class="text-warning">{{ reservations|selectattr('status', 'equalto', 'pending')|list|length }}</h4>
                                <p class="text-muted mb-0">–û–∂–∏–¥–∞—é—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded border">
                                <h4 class="text-success">{{ reservations|selectattr('status', 'equalto', 'confirmed')|list|length }}</h4>
                                <p class="text-muted mb-0">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-light rounded border">
                                <h4 class="text-primary">{{ reservations|selectattr('payments_status', 'equalto', 'paid')|list|length }}</h4>
                                <p class="text-muted mb-0">–û–ø–ª–∞—á–µ–Ω—ã</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="registerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üè® –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≥–æ—Å—Ç–µ–π</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="modalContent">
                    <div class="text-center">
                        <div class="spinner-border" role="status"></div>
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function openRegisterModal(reservationId, guestName, hotelId, roomCategoryId, startDate, endDate, payerId) {
        var modal = new bootstrap.Modal(document.getElementById('registerModal'));
        modal.show();

        window.currentPayerId = payerId;

        var xhr = new XMLHttpRequest();
        xhr.open('GET', '/api/available-rooms/' + hotelId + '?room_category_id=' + roomCategoryId + '&start_date=' + startDate + '&end_date=' + endDate);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var rooms = JSON.parse(xhr.responseText);
                    if (rooms.length > 0) {
                        displayRoomsForm(reservationId, guestName, rooms, payerId);
                    } else {
                        document.getElementById('modalContent').innerHTML =
                            '<div class="alert alert-warning">' +
                            '<h6>–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤</h6>' +
                            '<p>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã.</p>' +
                            '</div>';
                    }
                } else {
                    document.getElementById('modalContent').innerHTML =
                        '<div class="alert alert-danger">' +
                        '<h6>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h6>' +
                        '<p>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤.</p>' +
                        '</div>';
                }
            }
        };
        xhr.send();
    }

    function displayRoomsForm(reservationId, guestName, rooms, payerId) {
        var roomOptions = '';
        for (var i = 0; i < rooms.length; i++) {
            var room = rooms[i];
            roomOptions += '<option value="' + room.id + '">';
            roomOptions += '–ù–æ–º–µ—Ä ' + room.room_number + ' (' + room.category_name + ') - –≠—Ç–∞–∂ ' + room.floor;
            if (room.view) {
                roomOptions += ' - ' + room.view;
            }
            roomOptions += '</option>';
        }

        var content = '';
        content += '<div class="mb-3">';
        content += '<h6>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ #' + reservationId + '</h6>';
        content += '<p><strong>–ì–æ—Å—Ç—å:</strong> ' + guestName + '</p>';
        content += '</div>';
        content += '<form id="registerForm">';
        content += '<input type="hidden" name="reservation_id" value="' + reservationId + '">';
        content += '<div class="mb-3">';
        content += '<label class="form-label">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä:</label>';
        content += '<select name="room_id" class="form-select" required>';
        content += '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä --</option>';
        content += roomOptions;
        content += '</select>';
        content += '</div>';
        content += '<div class="mb-3">';
        content += '<label class="form-label">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥–æ—Å—Ç—è:</label>';
        content += '<div class="form-check">';
        content += '<input type="checkbox" name="guest_ids" value="' + payerId + '" checked disabled>';
        content += '<label class="form-check-label">' + guestName + ' (–æ—Å–Ω–æ–≤–Ω–æ–π –≥–æ—Å—Ç—å)</label>';
        content += '</div>';
        content += '<small class="text-muted">–û—Å–Ω–æ–≤–Ω–æ–π –≥–æ—Å—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</small>';
        content += '</div>';
        content += '<div class="d-grid">';
        content += '<button type="submit" class="btn btn-success">‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Å—Ç–µ–π</button>';
        content += '</div>';
        content += '</form>';

        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('registerForm').addEventListener('submit', handleRegistration);
    }

    function handleRegistration(event) {
        event.preventDefault();

        var formData = new FormData(event.target);

        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/reception/register-guests');
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var modal = bootstrap.Modal.getInstance(document.getElementById('registerModal'));
                    modal.hide();

                    setTimeout(function() {
                        location.reload();
                    }, 500);
                } else {
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≥–æ—Å—Ç–µ–π');
                }
            }
        };
        xhr.send(formData);
    }
</script>
{% endblock %}